<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Folder List</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="{{ url_for('static', filename='jquery.min.js') }}"></script>
</head>
<body>
    <h1>Available Folders</h1>

    <!-- Server Time Display -->
    <table id="server-time-table">
        <thead>
            <tr>
                <th>Server Date</th>
                <th>Server Time</th>
                <th>Timezone</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td id="server-date">Loading...</td>
                <td id="server-time">Loading...</td>
                <td id="server-timezone">Loading...</td>
            </tr>
        </tbody>
    </table>

    <table id="folder-table">
        <thead>
            <tr>
                <th>Folder Name</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for folder in folders %}
            <tr>
                <td>{{ folder }}</td>
                <td>
                    <a href="{{ url_for('edit_schedule', folder_name=folder) }}">Edit Schedule</a> |
                    <a href="{{ url_for('manage_audio', folder_name=folder) }}">Manage Audio Files</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <form method="get" action="{{ url_for('create_folder') }}">
        <button type="submit">Create/Add Folder</button>
    </form>

    <script>
        $(document).ready(function() {
            // Server time synchronization
            let serverTimeOffset = null; // Offset between server and client in milliseconds (null = not synced yet)
            let lastSyncTime = 0; // Client timestamp of last sync

            // Function to update displayed time
            function updateDisplayedTime() {
                // Only update if we have successfully synced with server
                if (serverTimeOffset === null) {
                    console.log('Server time not synced yet, skipping update');
                    return; // Don't show browser time as fake server time
                }

                const now = new Date();
                const serverTime = new Date(now.getTime() + serverTimeOffset);

                const dateStr = serverTime.toISOString().split('T')[0];
                const timeStr = serverTime.toTimeString().split(' ')[0];

                $('#server-date').text(dateStr);
                $('#server-time').text(timeStr);
            }

            // Function to sync with server
            function syncWithServer() {
                const requestTime = Date.now();

                $.ajax({
                    url: '/api/server_time',
                    type: 'GET',
                    success: function(data) {
                        const responseTime = Date.now();
                        const roundTripTime = responseTime - requestTime;

                        // Estimate server time accounting for network latency
                        const serverTimestamp = data.timestamp * 1000 + (roundTripTime / 2);
                        serverTimeOffset = serverTimestamp - responseTime;
                        lastSyncTime = responseTime;

                        // Update timezone info
                        const timezoneText = data.timezone + ' (' + data.utc_offset + ')';
                        $('#server-timezone').text(timezoneText);

                        // Immediately update display
                        updateDisplayedTime();
                    },
                    error: function(xhr, status, error) {
                        console.log('Server time sync failed:', status, error);
                        serverTimeOffset = null; // Reset to prevent showing browser time
                        $('#server-date').text('N/A');
                        $('#server-time').text('Endpoint not available');
                        $('#server-timezone').text('N/A');
                    }
                });
            }

            // Initial sync
            syncWithServer();

            // Sync with server every 10 seconds
            setInterval(syncWithServer, 10000);

            // Update displayed time every second
            setInterval(updateDisplayedTime, 1000);
        });
    </script>
</body>
</html>
